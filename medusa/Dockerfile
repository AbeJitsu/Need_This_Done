# ============================================================================
# Medusa Backend Dockerfile
# ============================================================================
# Builds the Medusa headless ecommerce backend service
# Runs on port 9000 within the Docker network

FROM node:18-alpine

WORKDIR /app

# ============================================================================
# Install dependencies (including dev for TypeScript compilation)
# ============================================================================
COPY package.json package-lock.json ./
RUN npm install

# ============================================================================
# Copy source code
# ============================================================================
COPY . .

# ============================================================================
# Build TypeScript
# ============================================================================
RUN npm run build

# ============================================================================
# Remove dev dependencies to reduce image size
# ============================================================================
RUN npm prune --production

# ============================================================================
# Expose port
# ============================================================================
EXPOSE 9000

# ============================================================================
# Health check
# ============================================================================
HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
  CMD node -e "require('http').get('http://localhost:9000/admin', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"

# ============================================================================
# Start Medusa
# ============================================================================
CMD ["npm", "start"]
