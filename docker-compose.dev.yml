# Development Overrides for Docker Compose
# This file adds development-specific features on top of docker-compose.yml
# Think of it as special instructions for weekends when the restaurant is training staff
#
# How it works: Run with both files like this:
# docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# The dev file overrides the base file, so you get:
# - Instant code reload (change a file, refresh browser - no rebuild!)
# - Exposed ports for debugging
# - All dependencies installed (including dev tools)
# - Extra logging and debugging tools

services:
  app:
    # Use the development Dockerfile instead of production
    # Includes hot-reload, debugging tools, and all devDependencies
    build:
      context: ./app
      dockerfile: Dockerfile.dev

    # Mount your source code as a volume
    # Changes to files instantly appear in the container (no rebuild needed)
    # Like having a window between your editor and the running app
    volumes:
      - ./app:/app
      - /app/node_modules  # Keep node_modules in container (don't sync it)
      # Mount root .env.local into app directory so Next.js can read it
      # (Symlinks don't work across Docker volume boundaries)
      - ./.env.local:/app/.env.local:ro

    # Expose Next.js port for direct access (useful for debugging)
    # You can access the app at localhost:3000 directly
    ports:
      - "3000:3000"

    # Enable interactive mode for debugging
    # Allows you to use Node debugger and read real-time logs
    stdin_open: true
    tty: true

    # Allow container to reach host services (like Supabase on localhost)
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Pass environment for development
    # HYBRID SUPABASE SUPPORT:
    # - For LOCAL Supabase: Set SUPABASE_INTERNAL_URL=http://host.docker.internal:54321
    #   in your .env.local (Docker container needs this to reach host's localhost)
    # - For CLOUD Supabase: Don't set SUPABASE_INTERNAL_URL (cloud URL works from anywhere)
    environment:
      - NODE_ENV=development
      # Only pass SUPABASE_INTERNAL_URL if set in .env (for local Supabase)
      # Cloud Supabase doesn't need this - the public URL works from Docker
    env_file:
      - .env.local

  redis:
    # Expose Redis port for direct debugging if needed
    # You can connect to Redis directly for testing
    ports:
      - "6379:6379"

  # ==========================================================================
  # Storybook - Component Library Development Server (Dev-Only)
  # ==========================================================================
  # Runs Storybook dev server for interactive component development
  # Accessible at http://localhost:6006 during development
  # NOT included in production - dev tool only

  storybook:
    # Use the same dev Dockerfile as the app
    # We'll override the command to run Storybook instead
    build:
      context: ./app
      dockerfile: Dockerfile.dev

    container_name: storybook_dev

    # Share source code with app service for hot reload
    # Changes to components appear instantly in both app and Storybook
    volumes:
      - ./app:/app
      - /app/node_modules  # Preserve node_modules in container

    # Expose Storybook's default port to host
    # Access at http://localhost:6006
    ports:
      - "6006:6006"

    # Override the default Next.js dev command
    # Run Storybook dev server instead
    # --ci flag prevents browser auto-open in container
    command: ["npm", "run", "storybook", "--", "--ci"]

    # Disable TTY mode to prevent terminal width calculation errors
    # This prevents the "Invalid count value: -8" error in terminal rendering
    stdin_open: false
    tty: false

    # Set development environment
    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      # Fix terminal rendering error (RangeError: Invalid count value: -8)
      # Explicitly set terminal dimensions to prevent Storybook from
      # miscalculating terminal width in Docker pseudo-TTY
      - COLUMNS=120
      - LINES=40

    # Storybook doesn't need to wait for other services
    # It's purely for component development
    # (No depends_on needed)

    # Join the app network for consistency
    # Allows future expansion if needed
    networks:
      - app_network

    # Don't restart automatically - manual intervention for dev errors
    restart: "no"
