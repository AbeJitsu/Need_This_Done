# Nightly Evaluation Fixes

Automated frontend evaluation findings and fixes.

---

## 2026-02-03 - Accessibility Audit

### Summary
Scanned `app/components/` for accessibility issues. Found and fixed 5 issues using TDD (failing test first, then minimal fix).

### Fixes Applied

#### 1. CompareButton - Missing Keyboard Accessibility
**File:** `app/components/CompareButton.tsx`
**Test:** `app/__tests__/components/CompareButton.a11y.test.tsx`
**Issue:** Button lacked `focus-visible` state for keyboard navigation and `aria-pressed` for toggle state.
**Fix:** Added `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2` and `aria-pressed={isSelected}`.
**Commit:** `Fix: Add keyboard accessibility to CompareButton`

#### 2. CouponInput - Dynamic Tailwind Class Won't Work
**File:** `app/components/CouponInput.tsx`
**Test:** `app/__tests__/components/CouponInput.a11y.test.tsx`
**Issue:** Used template literal `focus-visible:ring-${color}-500` which Tailwind can't statically analyze.
**Fix:** Created static lookup object `focusRingClasses` mapping each color to its complete class string.
**Commit:** `Fix: Use static focus ring classes in CouponInput`

#### 3. StarRating - Using focus: Instead of focus-visible:
**File:** `app/components/StarRating.tsx`
**Test:** `app/__tests__/components/StarRating.a11y.test.tsx`
**Issue:** Used `focus:` pseudo-class which shows rings on mouse click (bad UX). Should use `focus-visible:` for keyboard-only rings.
**Fix:** Changed to `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2`.
**Commit:** `Fix: Use focus-visible for StarRating keyboard navigation`

#### 4. StatusBadge - Missing Semantic Role
**File:** `app/components/StatusBadge.tsx`
**Test:** `app/__tests__/components/StatusBadge.a11y.test.tsx`
**Issue:** Screen readers couldn't identify the badge as a status indicator.
**Fix:** Added `role="status"` to the span element.
**Commit:** `Fix: Add role="status" to StatusBadge for screen reader accessibility`

#### 5. ProgressBar - Missing aria-valuetext
**File:** `app/components/ProgressBar.tsx`
**Test:** `app/__tests__/components/ProgressBar.a11y.test.tsx`
**Issue:** Screen readers only announced raw number (e.g., "75") without context.
**Fix:** Added `aria-valuetext` with human-readable text like "75% complete" or "Complete".
**Commit:** `Fix: Add aria-valuetext to ProgressBar for screen reader clarity`

### Additional Fix (Pre-existing)

#### 6. Stripe API Version Mismatch
**File:** `app/lib/stripe.ts`
**Issue:** API version `'2026-01-28.clover'` doesn't exist in installed `@types/stripe`.
**Fix:** Changed to `'2025-11-17.clover'` which matches the installed types.
**Commit:** `Fix: Update Stripe API version to match installed types`

### Build Status
Build fails due to **pre-existing infrastructure issue**: Supabase client initialization at module level in `api/admin/loyalty-analytics/route.ts` requires environment variables during static build. This is not related to the accessibility fixes - it's a build-time configuration issue that needs the Supabase URL available during `next build`.

### Test Results
All new accessibility tests pass:
- `CompareButton.a11y.test.tsx` ✅
- `CouponInput.a11y.test.tsx` ✅
- `StarRating.a11y.test.tsx` ✅
- `StatusBadge.a11y.test.tsx` ✅
- `ProgressBar.a11y.test.tsx` ✅
