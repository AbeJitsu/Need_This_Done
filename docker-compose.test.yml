# ============================================================================
# Docker Compose Test Configuration
# ============================================================================
# This file defines a test service that runs integration tests inside the
# Docker network. Tests connect to Redis and other services using Docker
# service names instead of localhost.
#
# Usage:
# docker-compose \
#   -f docker-compose.yml \
#   -f docker-compose.dev.yml \
#   -f docker-compose.test.yml \
#   up --build --abort-on-container-exit test
#
# Or add to package.json:
# "test:docker": "docker-compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.test.yml up --build --abort-on-container-exit test"

version: '3.8'

services:
  test:
    # Build test container from Dockerfile.test
    build:
      context: ./app
      dockerfile: Dockerfile.test

    container_name: integration_tests

    # ========================================================================
    # Network Configuration
    # ========================================================================
    # Join the same network as other services (redis, app, nginx)
    # This allows tests to access services using Docker service names:
    # - redis://redis:6379 (instead of localhost:6379)
    # - http://app:3000 (instead of localhost:3000)
    networks:
      - app_network

    # ========================================================================
    # Environment Variables
    # ========================================================================
    # Set up environment for tests running inside Docker network
    environment:
      # Test environment indicator
      - NODE_ENV=test

      # Redis connection using Docker service name
      # Services can reach each other by name on the Docker network
      - REDIS_URL=redis://redis:6379

      # Next.js app URL using Docker service name
      - APP_URL=https://nginx
      - NODE_TLS_REJECT_UNAUTHORIZED=0

      # Supabase configuration (same as anywhere else)
      # You can override these with .env file or docker-compose command line args
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:-http://localhost:54321}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:-test-key}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-test-role-key}

    # ========================================================================
    # Service Dependencies
    # ========================================================================
    # Wait for these services to be present before starting tests
    # Note: This doesn't guarantee they're READY, just that containers exist
    depends_on:
      - app
      - redis

    # ========================================================================
    # Container Behavior
    # ========================================================================
    # Don't restart on failure - tests should run once then exit
    restart: "no"

    # ========================================================================
    # Volumes (Optional - for faster test iteration during development)
    # ========================================================================
    # Uncomment to mount test files for live reloading during development
    # volumes:
    #   - ./app/__tests__:/app/__tests__
    #   - ./app/vitest.integration.config.ts:/app/vitest.integration.config.ts
    #   - ./app/vitest.integration.setup.ts:/app/vitest.integration.setup.ts

# ============================================================================
# Network Reference
# ============================================================================
# Reference the network created by docker-compose.yml
# This must be the external network that app and redis are connected to
networks:
  app_network:
    external: true
