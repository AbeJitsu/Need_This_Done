name: Deploy to DigitalOcean

on:
  workflow_dispatch:  # Manual trigger only - no auto-deploy
  # push:
  #   branches:
  #     - main
  #     - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to DigitalOcean
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          # Create SSH key file
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Add server to known_hosts to avoid interactive prompt
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # Deploy to server
          ssh -i ~/.ssh/deploy_key root@$DEPLOY_HOST << 'EOF'
          set -e
          cd /root/Need_This_Done

          echo "=================================================="
          echo "üöÄ Starting Deployment"
          echo "=================================================="
          echo ""

          # Step 1: Pull latest code
          echo "üìç Step 1/5: Pulling latest code from GitHub..."
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          echo "‚úÖ Code pulled successfully"
          echo ""

          # Step 2: Load environment variables
          echo "üìç Step 2/5: Loading environment variables..."
          if [ ! -f .env.local ]; then
            echo "‚ùå Error: .env.local not found!"
            exit 1
          fi
          source .env.local
          echo "‚úÖ Environment variables loaded"
          echo ""

          # Step 3: Build Next.js app
          echo "üìç Step 3/5: Building Next.js app with environment variables..."
          docker build --no-cache \
            --build-arg NEXT_PUBLIC_SUPABASE_URL="$NEXT_PUBLIC_SUPABASE_URL" \
            --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="$NEXT_PUBLIC_SUPABASE_ANON_KEY" \
            --build-arg NEXT_PUBLIC_SITE_URL="$NEXT_PUBLIC_SITE_URL" \
            --build-arg NEXT_PUBLIC_URL="$NEXT_PUBLIC_URL" \
            --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" \
            --build-arg NEXT_PUBLIC_CHATBOT_MODEL="$NEXT_PUBLIC_CHATBOT_MODEL" \
            --build-arg NEXT_PUBLIC_CHATBOT_MAX_TOKENS="$NEXT_PUBLIC_CHATBOT_MAX_TOKENS" \
            --build-arg NEXT_PUBLIC_CHATBOT_TEMPERATURE="$NEXT_PUBLIC_CHATBOT_TEMPERATURE" \
            -t need_this_done-app:latest -f app/Dockerfile app
          echo "‚úÖ Build completed successfully"
          echo ""

          # Step 4: Start containers
          echo "üìç Step 4/5: Starting Docker containers..."
          docker-compose --env-file .env.local -f docker-compose.yml -f docker-compose.prod.yml up -d --no-build
          echo "‚úÖ Containers started"
          echo ""

          # Step 5: Wait for health checks
          echo "üìç Step 5/5: Waiting for all services to be healthy..."
          MAX_ATTEMPTS=8
          DELAY=2
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            UNHEALTHY=$(docker ps --filter "health=unhealthy" --format "{{.Names}}" 2>/dev/null | wc -l)
            STARTING=$(docker ps --filter "health=starting" --format "{{.Names}}" 2>/dev/null | wc -l)

            if [ "$UNHEALTHY" -eq 0 ] && [ "$STARTING" -eq 0 ]; then
              echo "‚úÖ All services are healthy!"
              docker ps --format "table {{.Names}}\t{{.Status}}"
              echo ""
              echo "=================================================="
              echo "‚ú® Deployment Complete - All systems operational!"
              echo "=================================================="
              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              ELAPSED=$((DELAY * (ATTEMPT - 1)))
              echo "   Attempt $ATTEMPT/$MAX_ATTEMPTS: Waiting ${DELAY}s (${ELAPSED}s elapsed)..."
              sleep $DELAY
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "‚ùå Health check timeout after $((DELAY * MAX_ATTEMPTS))s"
          echo ""
          echo "Container status:"
          docker ps
          exit 1
          EOF

      - name: Verify deployment
        run: |
          echo ""
          echo "üîç Verifying site accessibility..."
          MAX_RETRIES=5
          RETRY=1

          while [ $RETRY -le $MAX_RETRIES ]; do
            RESPONSE=$(curl -k -s -w "\n%{http_code}" https://needthisdone.com/ 2>/dev/null || echo "timeout\n000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Site is accessible (HTTP $HTTP_CODE)"
              echo ""
              echo "Testing shop page..."
              SHOP_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" https://needthisdone.com/shop 2>/dev/null)
              if [ "$SHOP_CODE" = "200" ]; then
                echo "‚úÖ Shop page is accessible (HTTP $SHOP_CODE)"
              fi
              exit 0
            fi

            if [ $RETRY -lt $MAX_RETRIES ]; then
              echo "   Attempt $RETRY/$MAX_RETRIES: Site returned HTTP $HTTP_CODE, retrying in 5s..."
              sleep 5
            fi

            RETRY=$((RETRY + 1))
          done

          echo "‚ö†Ô∏è  Verification inconclusive (HTTP $HTTP_CODE), but deployment completed"

      - name: Deployment notification
        if: success()
        run: |
          echo ""
          echo "=================================================="
          echo "‚ú® Deployment Successful!"
          echo "=================================================="
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Site: https://needthisdone.com"
          echo "Shop: https://needthisdone.com/shop"
          echo ""

      - name: Deployment failed
        if: failure()
        run: |
          echo ""
          echo "=================================================="
          echo "‚ùå Deployment Failed"
          echo "=================================================="
          echo "Branch: ${{ github.ref }}"
          echo "Please check the logs above for details"
          echo "=================================================="
          exit 1
