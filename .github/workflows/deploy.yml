name: Deploy to DigitalOcean

on:
  workflow_dispatch:  # Manual trigger only - no auto-deploy
  # push:
  #   branches:
  #     - main
  #     - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to DigitalOcean
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          # Create SSH key file
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Add server to known_hosts to avoid interactive prompt
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # Deploy to server
          ssh -i ~/.ssh/deploy_key root@$DEPLOY_HOST << 'EOF'
          cd /root/Need_This_Done
          echo "Pulling latest code from GitHub..."
          git pull origin main
          echo "Loading environment variables..."
          source .env.local
          echo "Building Next.js app with explicit build args..."
          docker build --no-cache \
            --build-arg NEXT_PUBLIC_SUPABASE_URL="$NEXT_PUBLIC_SUPABASE_URL" \
            --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="$NEXT_PUBLIC_SUPABASE_ANON_KEY" \
            --build-arg NEXT_PUBLIC_SITE_URL="$NEXT_PUBLIC_SITE_URL" \
            --build-arg NEXT_PUBLIC_URL="$NEXT_PUBLIC_URL" \
            --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" \
            --build-arg NEXT_PUBLIC_CHATBOT_MODEL="$NEXT_PUBLIC_CHATBOT_MODEL" \
            --build-arg NEXT_PUBLIC_CHATBOT_MAX_TOKENS="$NEXT_PUBLIC_CHATBOT_MAX_TOKENS" \
            --build-arg NEXT_PUBLIC_CHATBOT_TEMPERATURE="$NEXT_PUBLIC_CHATBOT_TEMPERATURE" \
            -t need_this_done-app:latest -f app/Dockerfile app
          echo "Starting Docker containers..."
          docker-compose --env-file .env.local -f docker-compose.yml -f docker-compose.prod.yml up -d --no-build

          echo "Waiting for services to be healthy (with exponential backoff)..."
          MAX_ATTEMPTS=8
          DELAY=1
          for i in $(seq 1 $MAX_ATTEMPTS); do
            UNHEALTHY=$(docker ps --filter "health=unhealthy" --format "{{.Names}}" | wc -l)
            STARTING=$(docker ps --filter "health=starting" --format "{{.Names}}" | wc -l)

            if [ "$UNHEALTHY" -eq 0 ] && [ "$STARTING" -eq 0 ]; then
              echo "✓ All services healthy after attempt $i!"
              docker ps
              echo "✓ Deployment complete!"
              exit 0
            fi

            if [ $i -lt $MAX_ATTEMPTS ]; then
              echo "  Attempt $i/$MAX_ATTEMPTS: Services still starting, retrying in ${DELAY}s..."
              sleep $DELAY
              DELAY=$((DELAY * 2))
            fi
          done

          echo "⚠ Health check timeout - showing container status:"
          docker ps
          exit 1
          EOF

      - name: Verify deployment
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          echo "Checking if site is accessible..."
          curl -k https://needthisdone.com/ -I -w "\nStatus: %{http_code}\n" || echo "Site check in progress..."

      - name: Deployment notification
        if: success()
        run: echo "✓ Deployment to ${{ github.ref }} successful!"

      - name: Deployment failed
        if: failure()
        run: |
          echo "❌ Deployment failed on branch ${{ github.ref }}"
          exit 1
